# GitHub Actions Workflow â€“ Windowsâ€‘only Release build
# Save as .github/workflows/build.yml (or replace your existing one)

name: build

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    # ğŸ‘‰ åªåœ¨æœ€æ–°ç‰ˆ Windows runner ä¸Šæ‰§è¡Œ
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        build_type: [Release]   # åªç¼– Release
        ui: [gui]              # å¦‚éœ€ CLI è¯·æ”¹ä¸º [gui, cli]
        scripting: [lua]       # æŒ‰éœ€æ”¹ä¸º [lua, noscripts]

    steps:
    # 1ï¸âƒ£ æ‹‰æºç ï¼ˆå«å­æ¨¡å—ï¼‰
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    # 2ï¸âƒ£ Ninja æ„å»ºå·¥å…·
    - uses: aseprite/get-ninja@main

    # 3ï¸âƒ£ MSVC ç¯å¢ƒåˆå§‹åŒ–
    - uses: ilammy/msvc-dev-cmd@v1

    # 4ï¸âƒ£ ä¸‹è½½ / è§£å‹ Skiaï¼ˆäºŒè¿›åˆ¶åŒ…ç”± aseprite é¡¹ç›®è„šæœ¬æä¾›ï¼‰
    - name: Install Skia
      if: ${{ matrix.ui == 'gui' }}
      shell: bash
      run: |
        this_dir=$(cygpath "${{ github.workspace }}")
        skia_url=$(source "$this_dir/laf/misc/skia-url.sh" | xargs)
        skia_file=$(basename "$skia_url")
        curl --ssl-revoke-best-effort -L -o "$skia_file" "$skia_url"
        unzip "$skia_file" -d skia

    # 5ï¸âƒ£ ç”Ÿæˆæ„å»ºæ–‡ä»¶
    - name: Generate Build Files
      shell: bash
      run: |
        export enable_ccache=off            # Windows æ²¡æœ‰ ccache
        export laf_backend=skia             # åªåš GUI æ„å»º
        export enable_scripting=on          # å¯ç”¨ Lua
        export skia_arch=x64

        cmake -S . -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DENABLE_TESTS=ON \
          -DENABLE_SCRIPTING=$enable_scripting \
          -DENABLE_CCACHE=$enable_ccache \
          -DLAF_BACKEND=$laf_backend \
          -DSKIA_DIR=$(realpath skia) \
          -DSKIA_LIBRARY_DIR=$(realpath skia/out/Release-$skia_arch)

    # 6ï¸âƒ£ ç¼–è¯‘
    - name: Build
      shell: bash
      run: |
        cd build && ninja

    # 7ï¸âƒ£ ä¸Šä¼ å¯æ‰§è¡Œæ–‡ä»¶ä½œä¸ºæ„ä»¶
    - name: Upload exe artifact
      uses: actions/upload-artifact@v4
      with:
        name: aseprite-${{ matrix.ui }}-${{ matrix.scripting }}-${{ matrix.build_type }}
        path: build/bin/*.exe
